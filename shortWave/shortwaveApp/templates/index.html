<!DOCTYPE html>
<html lang="en">

    {% load static %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>shortWave</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <script   src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{% static 'style.css' %}">

</head>
<body>
    <div id="container">
        <header>
            <h2>SHORTWAVE</h2>
        </header>
        <form id="myform">
            {% csrf_token %}
        <input type="text" id="url" name="link" placeholder="Enter the URL">
        <input type="submit" id="submitBtn" value="Shorten URL"> 
        </form>
        <div id="shortend_link"></div>
    </div>

    <script>
        let form = document.getElementById('myform')
        let shortend_link = document.getElementById('shortend_link')

        form.addEventListener('submit', function(e) {
            e.preventDefault()

            // clear previous result
            shortend_link.innerHTML = ''

            // show loading state
            shortend_link.innerHTML =
            `<div class="spinner-container">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>`;

            $.ajax({
                type: 'POST',
                url: "{% url 'create' %}",
                data: $('#myform').serialize(),
                success: function(data) {
                    if (data.shortcode) {

                        // create a clickable link
                        let fullUrl = window.location.origin + '/' + data.shortcode;
                        shortend_link.innerHTML =
                        `<div class="result-container">  
                            <p class="result-container">Your shortend URL</p>
                            <div class="url-display">
                                <a href="${fullUrl}" class="short-url" target="_blank">${fullUrl}</a>
                            </div>
                            <div class="action-buttons">
                                <button class="copy-btn" data-url="${fullUrl}">
                                    <i class="bi bi-clipboard"> </i>
                                    Copy Link
                                </button>
                                <button class="refresh-btn" onclick="location.reload()">
                                    <i class="bi bi-arrow-repeat"></i>
                                    Shorten Another URL
                                </button>    
                            </div>                             
                        </div>`;

                        // Add copy functionality
                        document.querySelector('.copy-btn').addEventListener('click', function() {
                            navigator.clipboard.writeText(this.getAttribute('data-url'))
                                .then(() => {
                                    this.innerHTML = '<i class="bi bi-check2"></i> Copied!';
                                    this.classList.add('copied');
                                    setTimeout(() => {
                                        this.innerHTML = '<i class="bi bi-clipboard"></i> Copy Link';
                                        this.classList.remove('copied');
                                    }, 2000);
                                })
                                .catch(err => {
                                    console.error('Failed to copy: ', err);
                                });
                        });
                    } else {
                        shortend_link.innerHTML = 
                        `<div class="alert alert-danger">
                            Error: No shortcode received
                        </div>`;
                    }
                },

                error: function(xhr) {
                    let errorMsg = xhr.responseJSON?.error || 'Failed to shorten URL';
                    shortend_link.innerHTML = 
                    `<div class="alert alert-danger">
                        Error: ${errorMsg}   
                    </div>`;
                }
            })
        })
    </script>
    
</body>
</html>